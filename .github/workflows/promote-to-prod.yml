name: Promote Dev to Production

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "deploy" to confirm production deployment'
        required: true
        default: ''

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: Validate confirmation
        id: check
        run: |
          if [[ "${{ github.event.inputs.confirm }}" == "deploy" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… Deployment confirmed"
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "âŒ Deployment not confirmed. Type 'deploy' to confirm."
            exit 1
          fi

  create-pr:
    needs: validate
    if: needs.validate.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Create Pull Request
        id: create-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš€ Promote Dev to Production',
              body: `## Production Deployment
              
              This PR promotes the latest changes from \`develop\` to \`main\`.
              
              ### Deployment Checklist
              - [ ] All tests passing
              - [ ] Dev environment tested
              - [ ] Database migrations reviewed (if any)
              - [ ] Environment variables updated (if needed)
              
              ### Changes Included
              See commit history below for all changes being promoted.
              
              **Triggered by**: @${{ github.actor }}
              **Time**: ${new Date().toISOString()}`,
              head: 'develop',
              base: 'main',
              draft: false
            });
            
            core.setOutput('pr_number', pr.number);
            core.setOutput('pr_url', pr.html_url);
            
      - name: Auto-merge PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ steps.create-pr.outputs.pr_number }},
              merge_method: 'merge',
              commit_title: 'Deploy to Production: Merge develop into main',
              commit_message: 'Automated production deployment triggered by ${{ github.actor }}'
            });
            
      - name: Summary
        run: |
          echo "## Production Promotion Complete" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Successfully merged develop into main" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ Pull Request: ${{ steps.create-pr.outputs.pr_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The production deployment workflow will now trigger automatically." >> $GITHUB_STEP_SUMMARY